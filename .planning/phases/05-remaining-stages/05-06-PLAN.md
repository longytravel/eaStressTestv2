---
phase: 05-remaining-stages
plan: 06
type: execute
---

<objective>
Implement StressScenariosStage (Step 12) and ForwardWindowsStage (Step 13).

Purpose: Run stress tests and compute time-window performance analysis.
Output: `ea_stress/stages/s12_stress_scenarios.py` and `ea_stress/stages/s13_forward_windows.py`
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Prior summaries:
@.planning/phases/04-stage-framework/04-01-SUMMARY.md
@.planning/phases/05-remaining-stages/05-05-SUMMARY.md

# Specifications:
@.planning/phases/01-specification/specs/step-12-stress-scenarios.md
@.planning/phases/01-specification/specs/step-13-forward-windows.md

# Existing patterns:
@ea_stress/stages/base.py
@ea_stress/stages/s05_validate_trades.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement StressScenariosStage class</name>
  <files>ea_stress/stages/s12_stress_scenarios.py</files>
  <action>
Create StressScenariosStage following the Stage protocol.

This stage runs stress tests on the best pass:
1. Read best pass params from Step 9
2. Build dynamic scenario suite (rolling windows, calendar months)
3. For each scenario:
   - Run mt5.backtest() with window dates and model
   - Track tick file coverage for tick-model scenarios
4. Compute cost overlays from trade lists (post-hoc)

Key from spec (step-12-stress-scenarios.md):
- Window types: rolling (7/14/30/60/90 days), calendar months (1/2/3 ago)
- Models: OHLC (1) and Tick (0)
- Tick latency variants: 250ms, 5000ms
- Overlays: spread/slippage applied to trade list

Gate: None (informational step).

Return StageResult with:
- pass_num: Which pass was tested
- scenario_count: Total scenarios including overlays
- baseline: Original Step 9 result for comparison
- scenarios: List of scenario results with metrics

Use deterministic report naming: {ea_stem}_S12_{scenario_id}_{hash8}
  </action>
  <verify>python -c "from ea_stress.stages.s12_stress_scenarios import StressScenariosStage; print(StressScenariosStage().name)"</verify>
  <done>StressScenariosStage class exists with name '12_stress_scenarios'</done>
</task>

<task type="auto">
  <name>Task 2: Implement ForwardWindowsStage class</name>
  <files>ea_stress/stages/s13_forward_windows.py</files>
  <action>
Create ForwardWindowsStage following the Stage protocol.

This stage computes time-window metrics from trade list (no MT5 runs):
1. Read best pass report from Step 9
2. Extract trade list from report
3. Build windows: full, in_sample, forward, rolling, calendar, yearly
4. For each window:
   - Filter trades by close_time
   - Compute metrics: profit, PF, drawdown, trades, win_rate

Key from spec (step-13-forward-windows.md):
- No MT5 execution - pure trade list filtering
- Starting balance tracks accumulated profit before window start
- Drawdown relative to running peak within window
- Window kinds: full, segment, rolling, calendar, year

Gate: None (informational step).

Return StageResult with:
- pass_num: Which pass was analyzed
- report_path: Source report
- window_count: Number of windows computed
- windows: List of window results with metrics

Skip if no trade list available.
  </action>
  <verify>python -c "from ea_stress.stages.s13_forward_windows import ForwardWindowsStage; print(ForwardWindowsStage().name)"</verify>
  <done>ForwardWindowsStage class exists with name '13_forward_windows'</done>
</task>

<task type="auto">
  <name>Task 3: Export stages from package</name>
  <files>ea_stress/stages/__init__.py</files>
  <action>
Add StressScenariosStage and ForwardWindowsStage to lazy imports.

Update _stage_modules dict:
  "StressScenariosStage": "s12_stress_scenarios"
  "ForwardWindowsStage": "s13_forward_windows"

Add to __all__ list.
  </action>
  <verify>python -c "from ea_stress.stages import StressScenariosStage, ForwardWindowsStage"</verify>
  <done>Both stages importable from ea_stress.stages</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `python -c "from ea_stress.stages import StressScenariosStage, ForwardWindowsStage"` succeeds
- [ ] `python -m pytest -q` passes all existing tests
- [ ] StressScenariosStage.name returns "12_stress_scenarios"
- [ ] ForwardWindowsStage.name returns "13_forward_windows"
</verification>

<success_criteria>

- StressScenariosStage runs multi-window stress tests
- ForwardWindowsStage computes metrics without MT5
- Both are informational (no gates)
- All existing tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/05-remaining-stages/05-06-SUMMARY.md`
</output>
