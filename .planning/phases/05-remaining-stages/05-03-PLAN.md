---
phase: 05-remaining-stages
plan: 03
type: execute
---

<objective>
Implement ParseResultsStage (Step 8) and SelectPassesStage (Step 8B).

Purpose: Parse optimization XML and select top passes for backtesting.
Output: `ea_stress/stages/s08_parse_results.py` and `ea_stress/stages/s08b_select_passes.py`
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Prior summaries:
@.planning/phases/04-stage-framework/04-01-SUMMARY.md
@.planning/phases/05-remaining-stages/05-02-SUMMARY.md

# Specifications:
@.planning/phases/01-specification/specs/optimization-loop-python.md
@.planning/phases/01-specification/specs/optimization-loop-overview.md

# Existing patterns:
@ea_stress/stages/base.py
@ea_stress/stages/s05_validate_trades.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement ParseResultsStage class</name>
  <files>ea_stress/stages/s08_parse_results.py</files>
  <action>
Create ParseResultsStage following the Stage protocol.

This stage parses MT5 optimization XML results:
1. Read xml_path from Step 7 result
2. Parse Excel Spreadsheet ML format (urn:schemas-microsoft-com:office:spreadsheet)
3. Extract pass data: result, profit, profit_factor, drawdown, trades, params
4. Merge forward results if forward_xml_path exists
5. Filter by ONTESTER_MIN_TRADES (lower threshold for genetic exploration)

Key from spec:
- XML uses Excel Spreadsheet ML format with <Workbook>, <Worksheet>, <Table>, <Row>, <Cell>
- Forward/back merge by Pass number
- Result fields to extract: Pass, Result, Profit, Profit Factor, Expected Payoff, Drawdown, Trades, etc.
- Build params dict from remaining columns

Gate: valid_passes >= 1 (at least one pass meeting min trades).

Return StageResult with:
- total_passes: Raw pass count from optimization
- valid_passes: Passes meeting minimum trades
- passes: List of pass dicts with all metrics and params
- consistent_passes: Passes with both back and forward positive
  </action>
  <verify>python -c "from ea_stress.stages.s08_parse_results import ParseResultsStage; print(ParseResultsStage().name)"</verify>
  <done>ParseResultsStage class exists with name '8_parse_results'</done>
</task>

<task type="auto">
  <name>Task 2: Implement SelectPassesStage class</name>
  <files>ea_stress/stages/s08b_select_passes.py</files>
  <action>
Create SelectPassesStage following the Stage protocol.

This stage selects top N passes for backtesting:
1. Read passes from Step 8 result
2. Calculate composite "Go Live Score" for each pass using weights from settings
3. Sort by score (or profit if configured)
4. Select top N (settings.TOP_PASSES_BACKTEST, default 30)

Go Live Score calculation from spec:
- consistency: 0.25 (both back+forward positive)
- total_profit: 0.25 (normalized 0-5000)
- trade_count: 0.20 (normalized 50-200)
- profit_factor: 0.15 (normalized 1.0-3.0)
- max_drawdown: 0.15 (inverted, normalized 0-30%)

Two modes:
- auto_stats_analysis=True: Deterministic scoring (this stage handles it)
- auto_stats_analysis=False: Workflow pauses for LLM selection

Gate: None (selection is internal step).

Return StageResult with:
- selected_passes: List of pass numbers selected
- selection_method: 'auto' or 'manual'
- top_pass: Best pass by score
- scores: Dict of pass_num -> score
  </action>
  <verify>python -c "from ea_stress.stages.s08b_select_passes import SelectPassesStage; print(SelectPassesStage().name)"</verify>
  <done>SelectPassesStage class exists with name '8b_select_passes'</done>
</task>

<task type="auto">
  <name>Task 3: Export stages from package</name>
  <files>ea_stress/stages/__init__.py</files>
  <action>
Add ParseResultsStage and SelectPassesStage to lazy imports.

Update _stage_modules dict:
  "ParseResultsStage": "s08_parse_results"
  "SelectPassesStage": "s08b_select_passes"

Add to __all__ list.
  </action>
  <verify>python -c "from ea_stress.stages import ParseResultsStage, SelectPassesStage"</verify>
  <done>Both stages importable from ea_stress.stages</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `python -c "from ea_stress.stages import ParseResultsStage, SelectPassesStage"` succeeds
- [ ] `python -m pytest -q` passes all existing tests
- [ ] ParseResultsStage.name returns "8_parse_results"
- [ ] SelectPassesStage.name returns "8b_select_passes"
</verification>

<success_criteria>

- ParseResultsStage parses MT5 Excel Spreadsheet ML format
- SelectPassesStage implements Go Live Score calculation
- Both handle auto/manual selection modes
- All existing tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/05-remaining-stages/05-03-SUMMARY.md`
</output>
