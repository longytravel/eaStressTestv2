---
phase: 05-remaining-stages
plan: 02
type: execute
---

<objective>
Implement CreateINIStage (Step 6) and RunOptimizationStage (Step 7).

Purpose: Build the optimization configuration and execution stages.
Output: `ea_stress/stages/s06_create_ini.py` and `ea_stress/stages/s07_run_optimization.py`
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Prior summaries:
@.planning/phases/04-stage-framework/04-01-SUMMARY.md
@.planning/phases/05-remaining-stages/05-01-SUMMARY.md

# Specifications:
@.planning/phases/01-specification/specs/optimization-loop-python.md

# Existing patterns:
@ea_stress/stages/base.py
@ea_stress/stages/s05_validate_trades.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement CreateINIStage class</name>
  <files>ea_stress/stages/s06_create_ini.py</files>
  <action>
Create CreateINIStage following the Stage protocol.

This stage converts optimization_ranges to MT5 INI format:
1. Read optimization_ranges from Step 4 result
2. Generate INI file content using MT5 format:
   - [Tester] section with EA, symbol, period, dates, forward mode
   - [TesterInputs] section with param lines: name=value||start||step||stop||Y/N
3. Write INI file to workflow directory

Key from spec (optimization-loop-python.md):
- Boolean handling: true/false strings (known issue noted in spec)
- Parameter line format: {name}={value}||{start}||{step}||{stop}||{Y/N}
- Safety params forced to fixed values for optimization
- Use settings for: DEPOSIT, CURRENCY, LEVERAGE, DATA_MODEL, etc.

Gate: None (INI generation is internal step).

Return StageResult with:
- ini_path: Path to generated INI file
- param_count: Number of parameters
- optimizing_count: Number of params marked for optimization (Y)

Use deterministic naming: {ea_stem}_S6_opt_{symbol}_{timeframe}_{workflow_id[:8]}.ini
  </action>
  <verify>python -c "from ea_stress.stages.s06_create_ini import CreateINIStage; print(CreateINIStage().name)"</verify>
  <done>CreateINIStage class exists with name '6_create_ini'</done>
</task>

<task type="auto">
  <name>Task 2: Implement RunOptimizationStage class</name>
  <files>ea_stress/stages/s07_run_optimization.py</files>
  <action>
Create RunOptimizationStage following the Stage protocol.

This stage runs MT5 genetic optimization:
1. Read INI path from Step 6 result
2. Call mt5.optimize() with INI file
3. Handle timeout (settings.OPTIMIZATION_TIMEOUT, default 10 hours)

Key from spec:
- Uses MT5Interface.optimize() method
- Progress logging every 60 seconds
- Returns XML report path for parsing

Gate: passes_found > 0 (at least one valid pass).

Return StageResult with:
- xml_path: Path to optimization results XML
- forward_xml_path: Path to forward results XML (if ForwardMode enabled)
- report_name: Deterministic report name used
- duration_seconds: How long optimization ran

Use deterministic report naming from CreateINIStage.
  </action>
  <verify>python -c "from ea_stress.stages.s07_run_optimization import RunOptimizationStage; print(RunOptimizationStage().name)"</verify>
  <done>RunOptimizationStage class exists with name '7_run_optimization'</done>
</task>

<task type="auto">
  <name>Task 3: Export stages from package</name>
  <files>ea_stress/stages/__init__.py</files>
  <action>
Add CreateINIStage and RunOptimizationStage to lazy imports.

Update _stage_modules dict:
  "CreateINIStage": "s06_create_ini"
  "RunOptimizationStage": "s07_run_optimization"

Add to __all__ list.
  </action>
  <verify>python -c "from ea_stress.stages import CreateINIStage, RunOptimizationStage"</verify>
  <done>Both stages importable from ea_stress.stages</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `python -c "from ea_stress.stages import CreateINIStage, RunOptimizationStage"` succeeds
- [ ] `python -m pytest -q` passes all existing tests
- [ ] CreateINIStage.name returns "6_create_ini"
- [ ] RunOptimizationStage.name returns "7_run_optimization"
</verification>

<success_criteria>

- CreateINIStage generates valid MT5 INI format
- RunOptimizationStage calls MT5Interface.optimize
- Both stages follow Stage protocol pattern
- All existing tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/05-remaining-stages/05-02-SUMMARY.md`
</output>
