---
phase: 05-remaining-stages
plan: 04
type: execute
---

<objective>
Implement BacktestPassesStage (Step 9) and MonteCarloStage (Step 10).

Purpose: Run detailed backtests on selected passes and Monte Carlo simulation.
Output: `ea_stress/stages/s09_backtest_passes.py` and `ea_stress/stages/s10_monte_carlo.py`
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Prior summaries:
@.planning/phases/04-stage-framework/04-01-SUMMARY.md
@.planning/phases/05-remaining-stages/05-03-SUMMARY.md

# Specifications:
@.planning/phases/01-specification/specs/step-09-backtest-passes.md
@.planning/phases/01-specification/specs/step-10-monte-carlo.md

# Existing patterns:
@ea_stress/stages/base.py
@ea_stress/stages/s05_validate_trades.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement BacktestPassesStage class</name>
  <files>ea_stress/stages/s09_backtest_passes.py</files>
  <action>
Create BacktestPassesStage following the Stage protocol.

This stage runs full backtests on each selected pass:
1. Read selected_passes from Step 8B result
2. Read pass params from Step 8 result
3. For each pass:
   - Extract input params (filter out result fields)
   - Add fixed safety params
   - Run mt5.backtest()
   - Calculate composite score
   - Track best pass

Key from spec (step-09-backtest-passes.md):
- Result fields to filter: Pass, Forward Result, Back Result, Custom, Result
- Apply fixed_params for safety overrides
- Calculate composite score using Go Live Score formula
- Bonus +0.5 for positive forward AND back
- Select best by 'score' or 'profit' (settings.BEST_PASS_SELECTION)

Gates per pass:
- profit_factor >= MIN_PROFIT_FACTOR (1.5)
- max_drawdown <= MAX_DRAWDOWN_PCT (30%)
- minimum_trades >= MIN_TRADES (50)

Return StageResult with:
- best_result: Best pass full result dict
- all_results: List of all pass results
- successful_count: Passes that passed all gates
- total_count: Total passes backtested
  </action>
  <verify>python -c "from ea_stress.stages.s09_backtest_passes import BacktestPassesStage; print(BacktestPassesStage().name)"</verify>
  <done>BacktestPassesStage class exists with name '9_backtest_passes'</done>
</task>

<task type="auto">
  <name>Task 2: Implement MonteCarloStage class</name>
  <files>ea_stress/stages/s10_monte_carlo.py</files>
  <action>
Create MonteCarloStage following the Stage protocol.

This stage runs Monte Carlo simulation on best pass:
1. Read best_result from Step 9
2. Extract trades list or estimate from summary stats
3. Run simulation: shuffle trades N times, track ruin/profit
4. Calculate statistics: confidence, ruin probability, percentiles

Key from spec (step-10-monte-carlo.md):
- Iterations: settings.MC_ITERATIONS (10000)
- Ruin threshold: 50% drawdown
- Track: final profit, max drawdown per sequence
- Calculate percentiles: 5, 10, 25, 50, 75, 90, 95

Trade extraction:
- If actual trades available, use them
- Otherwise estimate from: total_trades, win_rate, gross_profit, gross_loss

Gates:
- mc_confidence >= MC_CONFIDENCE_MIN (70%)
- mc_ruin <= MC_RUIN_MAX (5%)

Return StageResult with:
- confidence: % of sequences ending profitable
- ruin_probability: % of sequences hitting 50% drawdown
- expected_profit: Mean final profit
- median_profit: 50th percentile
- worst_case: 5th percentile
- best_case: 95th percentile
- percentiles: All percentile values
  </action>
  <verify>python -c "from ea_stress.stages.s10_monte_carlo import MonteCarloStage; print(MonteCarloStage().name)"</verify>
  <done>MonteCarloStage class exists with name '10_monte_carlo'</done>
</task>

<task type="auto">
  <name>Task 3: Export stages from package</name>
  <files>ea_stress/stages/__init__.py</files>
  <action>
Add BacktestPassesStage and MonteCarloStage to lazy imports.

Update _stage_modules dict:
  "BacktestPassesStage": "s09_backtest_passes"
  "MonteCarloStage": "s10_monte_carlo"

Add to __all__ list.
  </action>
  <verify>python -c "from ea_stress.stages import BacktestPassesStage, MonteCarloStage"</verify>
  <done>Both stages importable from ea_stress.stages</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `python -c "from ea_stress.stages import BacktestPassesStage, MonteCarloStage"` succeeds
- [ ] `python -m pytest -q` passes all existing tests
- [ ] BacktestPassesStage.name returns "9_backtest_passes"
- [ ] MonteCarloStage.name returns "10_monte_carlo"
</verification>

<success_criteria>

- BacktestPassesStage runs backtests for all selected passes
- MonteCarloStage implements shuffle simulation
- Both stages have proper gate checks
- All existing tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/05-remaining-stages/05-04-SUMMARY.md`
</output>
