---
phase: 01-specification
plan: 02
type: execute
---

<objective>
Document Steps 4-5 (Analyze Params, Validate Trades, Fix EA) - the parameter setup phase.

Purpose: Create complete specifications for LLM parameter analysis and trade validation.
Output: 3 spec files (steps 4, 5, 5b) in `.planning/phases/01-specification/specs/`
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-specification/01-CONTEXT.md
@.planning/phases/01-specification/01-01-SUMMARY.md

**Source files to analyze:**
@engine/runner.py (continue_with_params, _step_validate_trades, _step_fix_ea)
@engine/gates.py (check_min_trades)
@modules/backtest.py (validation backtest)
@settings.py (MIN_TRADES, validation thresholds, optimization settings)

**Skill contracts:**
@.claude/skills/param-analyzer/SKILL.md (Step 4 LLM integration)
@.claude/skills/mql5-fixer/SKILL.md (Step 5B LLM integration)

**Reference:**
@CLAUDE.md (Step 4 output contract)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Document Step 4 (Analyze Params) with Updated Contract</name>
  <files>.planning/phases/01-specification/specs/step-04-analyze-params.md</files>
  <action>This is the first LLM integration point. The /param-analyzer skill needs an UPDATED contract for the new architecture.

  **From runner.py:**
  - Read `continue_with_params()` method
  - Document the two required artifacts

  **CRITICAL - New Architecture Requirements:**

  The /param-analyzer skill must now produce:

  1. `wide_validation_params` - Same as before: loose settings to maximize trades for Step 5 validation

  2. `initial_optimization_ranges` - CHANGED: Must include ALL parameters except:
     - Magic numbers
     - Visual/display settings
     - Hardcoded identifiers

     This is for EXPLORATION, not optimization. Wide ranges, all params included.
     The /optimization-loop skill will refine these after analyzing what matters.

  **Document:**
  - Input: params from Step 3
  - Output: wide_validation_params (dict)
  - Output: initial_optimization_ranges (dict) - ALL explorable params
  - What to exclude: magic numbers, visuals (provide examples)
  - Range guidance: wide ranges for exploration

  **Pause point:**
  - Document workflow pause state (`awaiting_param_analysis`)
  - Document resume mechanism (`continue_with_params()`)

  This spec defines the handoff to the /optimization-loop skill.</action>
  <verify>Spec includes: ALL-param requirement, exclusion list, wide range guidance</verify>
  <done>Step 4 fully documented with updated contract for new architecture</done>
</task>

<task type="auto">
  <name>Task 2: Document Step 5 (Validate Trades)</name>
  <files>.planning/phases/01-specification/specs/step-05-validate-trades.md</files>
  <action>Document the trade validation step:

  **From runner.py:**
  - Read `_step_validate_trades()` method
  - Document how wide_validation_params are used
  - Document the validation backtest process

  **From modules/backtest.py:**
  - Read backtest execution logic
  - Document report parsing for trade count

  **From gates.py and settings.py:**
  - Read `check_min_trades()` gate
  - Document MIN_TRADES threshold (default value, configuration)
  - Document gate pass/fail conditions

  **Settings to capture:**
  - Backtest period settings (from settings.py)
  - Model settings (tick vs OHLC)
  - Any other validation-specific settings

  **Safety parameter handling:**
  - Document how injected safety params are loosened for validation
  - Explain why (avoid false "no trades" from tight safety limits)

  Include the exact data flow: wide params → backtest → trade count → gate check</action>
  <verify>Spec includes: MIN_TRADES threshold, backtest parameters, settings references</verify>
  <done>Step 5 fully documented with settings references</done>
</task>

<task type="auto">
  <name>Task 3: Document Step 5B (Fix EA)</name>
  <files>.planning/phases/01-specification/specs/step-05b-fix-ea.md</files>
  <action>Document the EA fix loop:

  **From runner.py:**
  - Read EA fix tracking (`ea_fix_attempts`, `max_ea_fix_attempts`)
  - Document the retry mechanism
  - Document when this step triggers (Step 5 fails with 0 trades)

  **From /mql5-fixer skill:**
  - Read the skill definition
  - Document what information is provided to the LLM
  - Document expected fix output

  **Loop behavior:**
  - Document max retry count (default: 3)
  - Document what happens after max retries (workflow fails)
  - Document restart_with_improved_ea() method

  **Important note for new architecture:**
  - If EA doesn't trade after Step 5B fixes, the problem is fundamental
  - The /optimization-loop expects a trading EA
  - Document this prerequisite clearly

  **Gate:**
  - Same as Step 5: MIN_TRADES threshold
  - Document that gate is re-checked after each fix attempt</action>
  <verify>Spec includes: retry mechanism, max attempts, prerequisite for optimization loop</verify>
  <done>Step 5B fully documented</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] All 3 spec files exist
- [ ] Step 4 documents ALL-param requirement for initial_optimization_ranges
- [ ] Step 4 documents exclusion criteria (magic numbers, visuals)
- [ ] Step 5 references actual settings from settings.py
- [ ] Step 5B documents prerequisite relationship with optimization loop
- [ ] LLM skill contracts are completely documented
</verification>

<success_criteria>

- Steps 4, 5, 5B fully documented
- /param-analyzer contract UPDATED for new architecture (ALL params)
- /mql5-fixer contract captured
- Clear handoff point defined: validated EA + initial ranges → /optimization-loop
  </success_criteria>

<output>
After completion, create `.planning/phases/01-specification/01-02-SUMMARY.md`:

---
phase: 01-specification
plan: 02
subsystem: specification
requires: [step-3-spec]
provides: [step-4-spec, step-5-spec, step-5b-spec]
affects: [01-03, 02-core-domain, 07-compatibility-shim]
key-decisions: [param-analyzer-all-params]
key-files: [.planning/phases/01-specification/specs/step-04-analyze-params.md, .planning/phases/01-specification/specs/step-05-validate-trades.md]
---

# Phase 01-specification Plan 02: Parameter Setup Summary

**[One-liner summary]**

## Accomplishments

- [Key outcomes]

## Files Created/Modified

- [List of spec files]

## Decisions Made

- /param-analyzer must produce ALL-param ranges for exploration (not optimized ranges)

## Issues Encountered

[Or "None"]

## Next Step

Ready for 01-03-PLAN.md (Optimization Loop)
</output>
