---
phase: 01-specification
plan: 03
type: execute
---

<objective>
Document the Optimization Loop (Steps 6-8) as a single intelligent unit handled by /optimization-loop skill.

Purpose: Create complete specification for the hybrid Python + LLM optimization system.
Output: 1 comprehensive spec file for the optimization loop in `.planning/phases/01-specification/specs/`
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-specification/01-CONTEXT.md
@.planning/phases/01-specification/01-02-SUMMARY.md

**Source files to analyze:**
@engine/runner.py (steps 6, 7, 8 implementations, reopt flow)
@engine/gates.py (optimization gates)
@modules/optimizer.py (MT5 optimization execution)
@modules/pass_analyzer.py (result parsing)
@modules/reopt_analyzer.py (re-optimization analysis - if exists)
@settings.py (ALL optimization settings - 4yr, 1yr forward, 10ms latency, timeouts, etc.)

**Current skill (to be deprecated/absorbed):**
@.claude/skills/stats-analyzer/SKILL.md (pass selection - absorbed into new skill)

**Reference:**
@CLAUDE.md (optimization documentation)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Document Optimization Loop Overview and Architecture</name>
  <files>.planning/phases/01-specification/specs/optimization-loop-overview.md</files>
  <action>Create the master specification for the optimization loop. This documents the NEW architecture.

  **Structure:**

  ```markdown
  # Optimization Loop Specification

  ## Overview
  The optimization loop is a single intelligent unit that:
  1. Runs MT5 optimization with ALL parameters (exploration)
  2. Analyzes which parameters matter
  3. Refines ranges and re-runs with focused parameters
  4. Repeats until LLM decides to proceed
  5. Selects final passes for backtesting

  ## Architecture
  - Hybrid: Python handles deterministic work, LLM handles decisions
  - Single skill (/optimization-loop) maintains full context across passes
  - Replaces: separate Steps 6, 7, 8, 8B and /stats-analyzer skill

  ## Inputs
  - initial_optimization_ranges from Step 4 (ALL params, wide ranges)
  - Settings from settings.py (4yr backtest, 1yr forward, 10ms latency, etc.)
  - Validated EA (confirmed trading from Step 5)

  ## Outputs
  - Selected passes for Step 9 backtesting
  - Optimization history (all passes from all runs)
  - Parameter importance analysis reports
  - Refined ranges used in final pass

  ## The Loop
  [Diagram of: Generate INI → Run Optimization → Parse → Analyze → Decide → Refine → Loop or Proceed]
  ```

  **Document from existing code:**
  - Current Step 6, 7, 8 implementations (what Python does)
  - Current reopt flow (what exists for re-optimization)
  - Settings used (capture ALL from settings.py)

  **Document new requirements:**
  - Parameter importance analysis (correlation, variance, interactions)
  - LLM decision points (when to loop, when to proceed)
  - Range refinement logic (remove dead params, add granularity)</action>
  <verify>Spec includes: architecture diagram, inputs/outputs, loop description</verify>
  <done>Optimization loop overview documented</done>
</task>

<task type="auto">
  <name>Task 2: Document Python Components (Deterministic Work)</name>
  <files>.planning/phases/01-specification/specs/optimization-loop-python.md</files>
  <action>Document all the Python/deterministic components of the optimization loop.

  **INI Generation (from current Step 6):**
  - Read `_step_create_ini()` in runner.py
  - Document INI file format for MT5
  - Document parameter range format
  - FLAG: Boolean bug (True/False vs 1/0) - must be fixed
  - Document safety param handling

  **MT5 Optimization Execution (from current Step 7):**
  - Read `_step_run_optimization()` in runner.py
  - Read modules/optimizer.py
  - Document MT5 terminal invocation
  - Document genetic optimization settings
  - Document progress logging ("still running" messages)
  - Document output (XML report location)

  **Result Parsing (from current Step 8):**
  - Read `_step_parse_results()` in runner.py
  - Read modules/pass_analyzer.py
  - Document XML parsing
  - Document pass data structure (ALL fields)
  - Document filtering (MIN_TRADES)

  **Settings - CAPTURE ALL:**
  - OPTIMIZATION_TIMEOUT (and note: should be configurable for local vs cloud)
  - Backtest period: 4 years
  - Forward test: 1 year
  - Latency: 10ms
  - Model settings
  - Any other optimization-related settings

  **NEW: Parameter Importance Analysis (Python stats):**
  - Document what analysis is needed:
    - Correlation: param value vs profit factor, drawdown
    - Variance: param distribution in winning vs losing passes
    - Interactions: params that only matter together
  - Document output format for LLM consumption</action>
  <verify>Spec includes: INI format, MT5 execution, parsing, ALL settings, stats analysis requirements</verify>
  <done>Python components fully documented</done>
</task>

<task type="auto">
  <name>Task 3: Document LLM Components and /optimization-loop Skill Contract</name>
  <files>.planning/phases/01-specification/specs/optimization-loop-skill.md</files>
  <action>Document the LLM decision-making components and the skill contract.

  **Skill Contract:**

  ```markdown
  # /optimization-loop Skill Specification

  ## Purpose
  Handle the entire optimization loop with intelligence.
  Maintain context across multiple optimization passes.
  Make decisions about when to refine and when to proceed.

  ## Invocation
  Called after Step 5 validation passes.
  Receives: initial_optimization_ranges, EA path, settings

  ## Internal Loop

  ### Pass N Execution
  1. Generate INI (delegates to Python)
  2. Run optimization (delegates to MT5)
  3. Parse results (delegates to Python)
  4. Receive parameter importance analysis (from Python)

  ### Decision Point (LLM)
  Given the analysis, decide:
  - LOOP: Refine ranges and run again
  - PROCEED: Select passes and continue to Step 9

  Decision factors:
  - Pass number (1 = usually loop, 2+ = evaluate)
  - Quality of results (are good passes emerging?)
  - Parameter clarity (do we know what matters?)
  - Diminishing returns (would another pass help?)

  ### Range Refinement (LLM + Python)
  If LOOP:
  - LLM interprets analysis: which params to remove, which to focus
  - Python generates new ranges with:
    - Dead params removed
    - Important params: tighter range, finer step
    - Interaction handling (if Use_X=false, remove X_Period)

  ### Pass Selection (LLM)
  If PROCEED:
  - Select top N passes for backtesting
  - Consider: score, diversity, risk profiles
  - Output: list of pass indices

  ## Outputs
  - selected_passes: list of indices for Step 9
  - optimization_history: all passes from all runs
  - final_ranges: the refined ranges used
  - analysis_reports: parameter importance findings
  ```

  **Decision Point Details:**
  - After Pass 1: Usually recommend re-optimization (we just explored)
  - After Pass 2: Evaluate if results improved meaningfully
  - After Pass 2: PAUSE and discuss with user if more passes would help
  - Document the pause/resume mechanism for this discussion

  **Absorbs /stats-analyzer:**
  - Document that /stats-analyzer is deprecated
  - Pass selection is now part of /optimization-loop
  - Same logic, but with full optimization context</action>
  <verify>Spec includes: complete skill contract, decision criteria, pause points, /stats-analyzer deprecation</verify>
  <done>/optimization-loop skill fully specified</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] Overview spec exists with architecture diagram
- [ ] Python components spec captures ALL settings from settings.py
- [ ] Boolean INI bug flagged for fixing
- [ ] Timeout configurability noted (local vs cloud)
- [ ] Parameter importance analysis requirements documented
- [ ] /optimization-loop skill contract complete
- [ ] Decision criteria documented (when to loop vs proceed)
- [ ] Pause point documented (after Pass 2 discussion)
- [ ] /stats-analyzer deprecation noted
</verification>

<success_criteria>

- Optimization loop fully documented as single unit
- Clear separation: Python (deterministic) vs LLM (decisions)
- /optimization-loop skill contract complete and actionable
- All existing settings captured
- New requirements (parameter analysis, range refinement) specified
- Ready for Phase 2 implementation
  </success_criteria>

<output>
After completion, create `.planning/phases/01-specification/01-03-SUMMARY.md`:

---
phase: 01-specification
plan: 03
subsystem: specification
requires: [step-4-spec, step-5-spec]
provides: [optimization-loop-spec]
affects: [02-core-domain, 04-stage-framework, 07-compatibility-shim]
key-decisions: [hybrid-optimization-loop, stats-analyzer-deprecated]
key-files: [.planning/phases/01-specification/specs/optimization-loop-overview.md, .planning/phases/01-specification/specs/optimization-loop-skill.md]
---

# Phase 01-specification Plan 03: Optimization Loop Summary

**[One-liner summary]**

## Accomplishments

- [Key outcomes]

## Files Created/Modified

- optimization-loop-overview.md - Architecture and flow
- optimization-loop-python.md - Python components (INI, MT5, parsing, stats)
- optimization-loop-skill.md - /optimization-loop skill contract

## Decisions Made

- Optimization loop is ONE skill, not separate steps
- Hybrid architecture: Python (stats) + LLM (decisions)
- /stats-analyzer deprecated, absorbed into /optimization-loop
- Pause after Pass 2 for user discussion

## Issues Encountered

[Or "None"]

## Next Step

Ready for 01-04-PLAN.md (Steps 9-11 Analysis)
</output>
